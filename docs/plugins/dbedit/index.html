<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>JSON Editor for JSCC</title>
    <link href="../jquery/jquery-ui.css" rel="stylesheet">
    <!-- Bootstrap Core CSS -->
     <link href="css/bootstrap.min.css" rel="stylesheet">
     <!-- Font-Awesome CSS -->
     <link href="font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">

     <script src="../../js/arrayhash.js"></script>
     <script src="../../js/filesaver.js"></script>
     <script src="../../js/linkparam.js"></script>
     <script src="js/jsoneditor.js"></script>
     <script src="js/predbedit.js"></script>
     <script>
     var vDataJSON = {};
     var vSchemaID =  "car"; // file defined in schema/globallibs.schema
     // Set the default CSS theme and icon library globally
     JSONEditor.defaults.theme = 'bootstrap3';
     JSONEditor.defaults.iconlib = 'fontawesome4';
    </script>
    <!-- BEGIN: load JSON schema -->
    <script src="schema/car.schema"></script>
    <script src="schema/globallibs.schema"></script>
    <script src="schema/elementdb.schema"></script>
    <!-- END:  load JSON schema -->
  </head>
  <body>
    <div id='editor_holder' style="margin:20px"></div>
    <div id='button_holder' style="margin:20px">
      <button id='export'>Export JSON</button>
      <button id='bWinClose' onclick="window.close()">Close</button>
      <button id='bExportEditorContent'>Export Editor innerHTML - Debug</button>
      <button id='view' onclick="console.log(JSON.stringify(editor.getValue()))" style="display:none">View (console.log)</button>
    </div>
    <script>
      //-------------------------------------------------------
      // SCHEMA: Initialize the editor with a default JSON schema
      var vSchemaJSON = vDataJSON["car"];
      //-------------------------------------------------------
      // LINK PARAMETER: Evaluation link parameter in JSON Path
      var vLinkParam = new LinkParam();
      vLinkParam.init(document);
      if (vLinkParam.exists("schema")) {
        vSchemaID = vLinkParam.getValue("schema");
      };
      //-------------------------------------------------------
      // InitJSON: Get the JSON data to init the Editor from Window Opener
      var vInitData;
      var vJSON;
      var vID = "";
      var vWinOpener = getWinOpener();
      if (typeof vWinOpener === "undefined") {
    		console.log("wWinOpener undefined - connection lost");
        $( "#bWinClose" ).hide();
        $( "#bExportEditorContent" ).show();
    	} else {
          //---load schema----
          if (vLinkParam.exists("db")) {
            vID = vLinkParam.getValue("db");
            console.log("JSON Database db='"+vID+"' defined ");
            if (vWinOpener.vJSCC_DB["DatabaseList"].hasOwnProperty(vID)) {
              vJSON = vWinOpener.vJSCC_DB["DatabaseList"][vID];
              if (vJSON.hasOwnProperty("data")) {
                console.log("Data Hash exists in DB ["+vID+"]");
              } else {
                vJSON["data"] = {};
              };
              if (vJSON.hasOwnProperty("schema")) {
                console.log("Database Schema exists in DB ["+vID+"]");
              } else {
                vJSON["schema"] = cloneJSON(vSchemaJSON);
              };
              vSchemaJSON = vJSON["schema"] 
            };
          } else if (vLinkParam.exists("jscc")) {
            vID = vLinkParam.getValue("jscc");
            console.log("JSON ID jscc='"+vID+"' defined ");
            if (vWinOpener.vJSCC_DB.hasOwnProperty(vID)) {
              console.log("JSON data jscc='"+vID+"' defined ");
              vJSON = vWinOpener.vJSCC_DB;
              vInitData = vJSON[vID];
            };
          }
      };
      //-------------------------------------------------------
      console.log("try setting schema '"+vSchemaID+"'");
      if (vDataJSON.hasOwnProperty(vSchemaID)) {
        vSchemaJSON = vDataJSON[vSchemaID];
      } else {
        alert("WARNING: Schema 'schema/"+vSchemaID+".schema' does not exist\nor was not loaded in JSON Editor 'plugins/dbedit/index.html'!\nUse default schema 'schema/car.schema'");
        console.log("use default schema 'car' for JSON Editor")
      };
      //-------------------------------------------------------
      // JSON: Database
      vStartVal = null;
      var editor = new JSONEditor(document.getElementById('editor_holder'),{
        ajax: true,
        schema: vSchemaJSON,
        startval: vInitData
      });
      //-------------------------------------------------------
      //---JSON EDITOR Handle Change Event---------------------
      editor.on('change',function() {
        if (vJSON) {
            vJSON[vID] = editor.getValue();
        }
      });
      //-------------------------------------------------------
      // Hook up the submit button to log to the console
      document.getElementById('export').addEventListener('click',function() {
        var vContent = JSON.stringify(editor.getValue(),null,4);
        // Get the value from the editor
        saveFile2HDD(vSchemaID+".json",vContent);
        //console.log(editor.getValue());
      });
      //-------------------------------------------------------
      // Hook up the submit button to log to the console
      document.getElementById('bExportEditorContent').addEventListener('click',function() {
        var vContent = JSON.stringify(getEditorInnerHTML("editor_holder"),null,4);
        // Get the value from the editor
        saveFile2HDD("editor_innerhtml.html",vContent);
        //console.log(editor.getValue());
      });
    </script>
    <script src="../jquery/external/jquery/jquery.js" type="text/javascript"></script>
  </body>
</html>
